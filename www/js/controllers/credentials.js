// Generated by CoffeeScript 1.9.3
(function() {
  angular.module('perkkx.controllers.credentials', []).controller('LoginCtrl', function($scope, $state, pxUserCred, $log, $cordovaToast) {
    $scope.data = {
      username: '',
      password: '',
      error: ""
    };
    $scope.state = {
      isLoading: true,
      loginPage: false,
      error: false
    };
    pxUserCred.confirmCreds(function(res) {
      $log.info("got result for confirmation as : " + res);
      $scope.state.isLoading = false;
      if (res) {
        if (pxUserCred.firstLogin()) {
          $state.go('change_pass');
        } else {
          $state.go('tab.redeem');
        }
      }
      return $scope.state.loginPage = true;
    });
    return $scope.submit = function() {
      $scope.state.isLoading = true;
      $scope.state.error = false;
      return pxUserCred.login($scope.data.username, $scope.data.password, function(res) {
        $scope.state.isLoading = false;
        if (!res) {
          $scope.state.error = true;
          return $scope.data.error = "Login failed";
        } else {
          $scope.data.username = '';
          $scope.data.password = '';
          if (pxUserCred.firstLogin()) {
            $state.go('change_pass');
          } else {
            $state.go('tab.redeem');
          }
          return $cordovaToast.show("Login success", "short", "bottom");
        }
      });
    };
  }).controller('ChangePassCtrl', function($scope, $state, pxUserCred, $log, $cordovaToast) {
    var clear, validate;
    $scope.data = {
      username: '',
      password_old: '',
      password_new: '',
      password_new_rep: '',
      error: ''
    };
    clear = function() {
      $scope.data.password_old = '';
      $scope.data.password_new = '';
      return $scope.data.password_new_rep = '';
    };
    $scope.state = {
      error: false,
      isLoading: false
    };
    pxUserCred.register(function(d) {
      return $scope.data.username = d.username;
    });
    validate = function() {
      var r1, r2;
      r1 = $scope.data.username !== '' && $scope.data.password_new !== '' && $scope.data.password_new === $scope.data.password_new_rep;
      r2 = $scope.firstLogin() || $scope.data.password_old !== '';
      return r1 && r2;
    };
    $scope.firstLogin = function() {
      return pxUserCred.firstLogin();
    };
    $scope.cancel = function() {
      clear();
      return $state.go('tab.redeem');
    };
    return $scope.submit = function() {
      $scope.state.isLoading = true;
      $scope.state.error = false;
      if (validate()) {
        if ($scope.firstLogin()) {
          return pxUserCred.new_pass($scope.data.username, $scope.data.password_new, function(res) {
            if (res) {
              $scope.state.error = false;
              return pxUserCred.login($scope.data.username, $scope.data.password_new, function(resl) {
                $scope.state.isLoading = false;
                clear();
                if (resl) {
                  $state.go('tab.redeem');
                  $log.debug("Password change for first timer success");
                  return $cordovaToast.show("Password changed successfully", "long", "bottom");
                } else {
                  $state.go('login');
                  $log.debug("Password change for first timer FAILED");
                  return $cordovaToast.show("Unexpected password change error", "long", "bottom");
                }
              });
            } else {
              $scope.state.isLoading = false;
              $scope.state.error = true;
              return $scope.data.error = "Unexpected password change error";
            }
          });
        } else {
          return pxUserCred.change_pass($scope.data.username, $scope.data.password_old, $scope.data.password_new, function(res) {
            $scope.state.isLoading = false;
            if (!res) {
              $scope.state.error = true;
              return $scope.data.error = "Password change failed";
            } else {
              $scope.state.error = false;
              clear();
              $state.go('login');
              return $cordovaToast.show("Password changed successfully, please login", "long", "bottom");
            }
          });
        }
      } else {
        $scope.state.isLoading = false;
        $scope.state.error = true;
        $scope.data.error = "the passwords do not match";
        return $log.debug("change pass: " + (JSON.stringify($scope.data)));
      }
    };
  });

}).call(this);
